# .github/workflows/main.yml (FINAL VERSION)

name: MLOps Retraining Pipeline

# This workflow is triggered by the "repository_dispatch" event
# which our AWS Lambda function sends.
on:
  repository_dispatch:
    types: [new-data-arrived] # This MUST match the "event_type" in the Lambda

  # Allows you to also run this workflow manually from the Actions tab
  workflow_dispatch:

# Set the MLflow server IP for all jobs
env:
  MLFLOW_TRACKING_URI: http://16.171.65.31:5000

jobs:
  train-and-evaluate:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Print the S3 file path
        run: |
          echo "Workflow triggered by new data!"
          echo "S3 Bucket: ${{ github.event.client_payload.s3_bucket }}"
          echo "S3 Key: ${{ github.event.client_payload.s3_key }}"

      - name: 2. Check out this repository's code
        uses: actions/checkout@v4

      - name: 3. Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: 4. Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: 5. Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1  # <-- FIXED: Set to Stockholm

      - name: 6. Download All Data from S3
        run: |
          # We will download the *entire* S3 bucket to a local folder
          # In a real project, you'd merge the new file with old, but this is simpler.
          echo "Downloading all data from s3://${{ github.event.client_payload.s3_bucket }} ..."
          aws s3 sync s3://${{ github.event.client_payload.s3_bucket }} ./
          
          echo "Files downloaded:"
          ls -l

      - name: 7. Run Full Pipeline (Train and Evaluate)
        run: |
          # The Training script will read churn_data_v1.csv and log to MLflow
          python scripts/train.py
          
          # The Evaluation script will check F1/Bias and deploy to Registry
          python scripts/evaluate.py